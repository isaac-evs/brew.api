<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Coffee Shop</title>
    </head>
    <body>
        <header>
            <h1>Coffee Shop</h1>
            <nav>
                <button onclick="showSection('home')">Home</button>
                <button onclick="showSection('menu')">Menu</button>
                <button onclick="showSection('cart')">
                    Cart (<span id="cart-count">0</span>)
                </button>
                <button id="auth-button" onclick="showSection('login')">
                    Login
                </button>
            </nav>
        </header>

        <main>
            <!-- Home Section -->
            <section id="home" class="active">
                <h2>Welcome to Our Coffee Shop</h2>
                <p>Discover our selection of premium coffee beverages.</p>
                <button onclick="showSection('menu')">View Menu</button>
            </section>

            <!-- Menu Section -->
            <section id="menu" class="hidden">
                <h2>Coffee Menu</h2>
                <div id="menu-items"></div>
            </section>

            <!-- Cart Section -->
            <section id="cart" class="hidden">
                <h2>Your Cart</h2>
                <div id="cart-items"></div>
                <div id="cart-total">Total: $0.00</div>
                <button id="place-order-btn" onclick="placeOrder()" disabled>
                    Place Order
                </button>
            </section>

            <!-- Login Section -->
            <section id="login" class="hidden">
                <h2>Login</h2>
                <form id="login-form">
                    <div>
                        <label for="email">Email:</label>
                        <input type="email" id="login-email" required />
                    </div>
                    <div>
                        <label for="password">Password:</label>
                        <input type="password" id="login-password" required />
                    </div>
                    <button type="submit">Login</button>
                </form>
                <p>
                    Don't have an account?
                    <button onclick="toggleAuthForms()">Register</button>
                </p>
            </section>

            <!-- Register Section -->
            <section id="register" class="hidden">
                <h2>Create Account</h2>
                <form id="register-form">
                    <div>
                        <label for="company-name">Company Name:</label>
                        <input type="text" id="company-name" required />
                    </div>
                    <div>
                        <label for="business-name">Business Name:</label>
                        <input type="text" id="business-name" required />
                    </div>
                    <div>
                        <label for="email">Email:</label>
                        <input type="email" id="register-email" required />
                    </div>
                    <div>
                        <label for="password">Password:</label>
                        <input
                            type="password"
                            id="register-password"
                            required
                        />
                    </div>
                    <div>
                        <label for="address">Address:</label>
                        <input type="text" id="address" required />
                    </div>
                    <div>
                        <label for="neighborhood">Neighborhood:</label>
                        <input type="text" id="neighborhood" required />
                    </div>
                    <div>
                        <label for="municipality">Municipality:</label>
                        <input type="text" id="municipality" required />
                    </div>
                    <div>
                        <label for="state">State:</label>
                        <input type="text" id="state" required />
                    </div>
                    <button type="submit">Register</button>
                </form>
                <p>
                    Already have an account?
                    <button onclick="toggleAuthForms()">Login</button>
                </p>
            </section>

            <!-- Order Confirmation Section -->
            <section id="order-confirmation" class="hidden">
                <h2>Order Placed!</h2>
                <p>
                    Thank you for your order. An email with your order details
                    has been sent to your registered email address.
                </p>
                <p>
                    You can download your receipt by clicking the link in the
                    email.
                </p>
                <button onclick="showSection('home')">Continue Shopping</button>
            </section>
        </main>

        <script>
            // API Base URL - replace with your actual API endpoint
            const API_BASE_URL = "http://localhost:8000";

            // State management
            const state = {
                user: null,
                cart: [],
                products: [],
                billingAddressId: null,
                shippingAddressId: null,
            };

            // Helper function to show/hide sections
            function showSection(sectionId) {
                document
                    .querySelectorAll("main > section")
                    .forEach((section) => {
                        section.classList.add("hidden");
                        section.classList.remove("active");
                    });
                document.getElementById(sectionId).classList.remove("hidden");
                document.getElementById(sectionId).classList.add("active");
            }

            // Toggle between login and register forms
            function toggleAuthForms() {
                const loginSection = document.getElementById("login");
                const registerSection = document.getElementById("register");

                if (loginSection.classList.contains("active")) {
                    loginSection.classList.add("hidden");
                    loginSection.classList.remove("active");
                    registerSection.classList.remove("hidden");
                    registerSection.classList.add("active");
                } else {
                    registerSection.classList.add("hidden");
                    registerSection.classList.remove("active");
                    loginSection.classList.remove("hidden");
                    loginSection.classList.add("active");
                }
            }

            // Load coffee menu
            async function loadMenu() {
                try {
                    // In a real app, you'd fetch this from your backend
                    // For now using mock data to simulate our products
                    const response = await fetch(`${API_BASE_URL}/products/`);
                    if (!response.ok) {
                        throw new Error("Failed to load products");
                    }

                    state.products = await response.json();

                    // If API returns empty, use mock data (for testing purposes)
                    if (state.products.length === 0) {
                        state.products = [
                            {
                                id: 1,
                                name: "Espresso",
                                unit_of_measure: "cup",
                                base_price: 2.5,
                            },
                            {
                                id: 2,
                                name: "Cappuccino",
                                unit_of_measure: "cup",
                                base_price: 3.5,
                            },
                            {
                                id: 3,
                                name: "Latte",
                                unit_of_measure: "cup",
                                base_price: 4.0,
                            },
                            {
                                id: 4,
                                name: "Americano",
                                unit_of_measure: "cup",
                                base_price: 3.0,
                            },
                            {
                                id: 5,
                                name: "Mocha",
                                unit_of_measure: "cup",
                                base_price: 4.5,
                            },
                        ];
                    }

                    renderMenu();
                } catch (error) {
                    console.error("Error loading menu:", error);
                    // Fallback to mock data if API fails
                    state.products = [
                        {
                            id: 1,
                            name: "Espresso",
                            unit_of_measure: "cup",
                            base_price: 2.5,
                        },
                        {
                            id: 2,
                            name: "Cappuccino",
                            unit_of_measure: "cup",
                            base_price: 3.5,
                        },
                        {
                            id: 3,
                            name: "Latte",
                            unit_of_measure: "cup",
                            base_price: 4.0,
                        },
                        {
                            id: 4,
                            name: "Americano",
                            unit_of_measure: "cup",
                            base_price: 3.0,
                        },
                        {
                            id: 5,
                            name: "Mocha",
                            unit_of_measure: "cup",
                            base_price: 4.5,
                        },
                    ];
                    renderMenu();
                }
            }

            // Render menu items
            function renderMenu() {
                const menuContainer = document.getElementById("menu-items");
                menuContainer.innerHTML = "";

                state.products.forEach((product) => {
                    const productElement = document.createElement("div");
                    productElement.innerHTML = `
                    <h3>${product.name}</h3>
                    <p>Price: $${product.base_price.toFixed(2)}</p>
                    <button onclick="addToCart(${product.id})">Add to Cart</button>
                `;
                    menuContainer.appendChild(productElement);
                });
            }

            // Add item to cart
            function addToCart(productId) {
                if (!state.user) {
                    alert("Please login to add items to cart");
                    showSection("login");
                    return;
                }

                const product = state.products.find((p) => p.id === productId);
                if (!product) return;

                // Check if product already in cart
                const existingItem = state.cart.find(
                    (item) => item.productId === productId,
                );

                if (existingItem) {
                    existingItem.quantity += 1;
                    existingItem.amount =
                        existingItem.quantity * existingItem.unitPrice;
                } else {
                    state.cart.push({
                        productId: product.id,
                        name: product.name,
                        quantity: 1,
                        unitPrice: product.base_price,
                        amount: product.base_price,
                    });
                }

                updateCartUI();
                alert(`${product.name} added to cart!`);
            }

            // Update cart UI
            function updateCartUI() {
                const cartContainer = document.getElementById("cart-items");
                const cartCount = document.getElementById("cart-count");
                const cartTotal = document.getElementById("cart-total");
                const placeOrderBtn =
                    document.getElementById("place-order-btn");

                cartContainer.innerHTML = "";

                if (state.cart.length === 0) {
                    cartContainer.innerHTML = "<p>Your cart is empty</p>";
                    placeOrderBtn.disabled = true;
                } else {
                    placeOrderBtn.disabled = false;
                    state.cart.forEach((item) => {
                        const itemElement = document.createElement("div");
                        itemElement.innerHTML = `
                        <p>${item.name} - $${item.unitPrice.toFixed(2)} x ${item.quantity} = $${item.amount.toFixed(2)}</p>
                        <button onclick="removeFromCart(${item.productId})">Remove</button>
                    `;
                        cartContainer.appendChild(itemElement);
                    });
                }

                // Update cart count
                const totalItems = state.cart.reduce(
                    (total, item) => total + item.quantity,
                    0,
                );
                cartCount.textContent = totalItems;

                // Update total
                const total = state.cart.reduce(
                    (total, item) => total + item.amount,
                    0,
                );
                cartTotal.textContent = `Total: $${total.toFixed(2)}`;
            }

            // Remove item from cart
            function removeFromCart(productId) {
                state.cart = state.cart.filter(
                    (item) => item.productId !== productId,
                );
                updateCartUI();
            }

            // Handle login form submission
            document
                .getElementById("login-form")
                .addEventListener("submit", async function (e) {
                    e.preventDefault();

                    const email = document.getElementById("login-email").value;
                    const password =
                        document.getElementById("login-password").value;

                    try {
                        // In a real app, you'd authenticate with your backend
                        // For demo purposes, we'll simulate a successful login
                        // and fetch user data based on email
                        const response = await fetch(
                            `${API_BASE_URL}/customers?email=${encodeURIComponent(email)}`,
                        );
                        if (!response.ok) {
                            throw new Error("Authentication failed");
                        }

                        const users = await response.json();
                        const user = users.find((u) => u.email === email);

                        if (!user) {
                            throw new Error("User not found");
                        }

                        // Get user addresses
                        const addressesResponse = await fetch(
                            `${API_BASE_URL}/addresses?customer_id=${user.id}`,
                        );
                        if (!addressesResponse.ok) {
                            throw new Error("Failed to load addresses");
                        }

                        const addresses = await addressesResponse.json();
                        const billingAddress = addresses.find(
                            (a) => a.address_type === "BILLING",
                        );
                        const shippingAddress = addresses.find(
                            (a) => a.address_type === "SHIPPING",
                        );

                        if (billingAddress)
                            state.billingAddressId = billingAddress.id;
                        if (shippingAddress)
                            state.shippingAddressId = shippingAddress.id;

                        // Set user in state
                        state.user = user;

                        // Update UI
                        document.getElementById("auth-button").textContent =
                            "Logout";
                        document.getElementById("auth-button").onclick = logout;

                        showSection("home");
                        alert(`Welcome, ${user.company_name}!`);
                    } catch (error) {
                        console.error("Login error:", error);
                        alert("Login failed. Please check your credentials.");
                    }
                });

            // Handle register form submission
            document
                .getElementById("register-form")
                .addEventListener("submit", async function (e) {
                    e.preventDefault();

                    const companyName =
                        document.getElementById("company-name").value;
                    const businessName =
                        document.getElementById("business-name").value;
                    const email =
                        document.getElementById("register-email").value;
                    const password =
                        document.getElementById("register-password").value;
                    const address = document.getElementById("address").value;
                    const neighborhood =
                        document.getElementById("neighborhood").value;
                    const municipality =
                        document.getElementById("municipality").value;
                    const state = document.getElementById("state").value;

                    try {
                        // Create customer
                        const customerResponse = await fetch(
                            `${API_BASE_URL}/customers/`,
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({
                                    company_name: companyName,
                                    business_name: businessName,
                                    email: email,
                                }),
                            },
                        );

                        if (!customerResponse.ok) {
                            throw new Error("Failed to create customer");
                        }

                        const customer = await customerResponse.json();

                        // Create billing address
                        const billingAddressResponse = await fetch(
                            `${API_BASE_URL}/addresses/`,
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({
                                    customer_id: customer.id,
                                    address: address,
                                    neighborhood: neighborhood,
                                    municipality: municipality,
                                    state: state,
                                    address_type: "BILLING",
                                }),
                            },
                        );

                        if (!billingAddressResponse.ok) {
                            throw new Error("Failed to create billing address");
                        }

                        const billingAddress =
                            await billingAddressResponse.json();

                        // Create shipping address (same as billing for simplicity)
                        const shippingAddressResponse = await fetch(
                            `${API_BASE_URL}/addresses/`,
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({
                                    customer_id: customer.id,
                                    address: address,
                                    neighborhood: neighborhood,
                                    municipality: municipality,
                                    state: state,
                                    address_type: "SHIPPING",
                                }),
                            },
                        );

                        if (!shippingAddressResponse.ok) {
                            throw new Error(
                                "Failed to create shipping address",
                            );
                        }

                        const shippingAddress =
                            await shippingAddressResponse.json();

                        // Set state
                        state.user = customer;
                        state.billingAddressId = billingAddress.id;
                        state.shippingAddressId = shippingAddress.id;

                        // Update UI
                        document.getElementById("auth-button").textContent =
                            "Logout";
                        document.getElementById("auth-button").onclick = logout;

                        showSection("home");
                        alert("Account created successfully!");
                    } catch (error) {
                        console.error("Registration error:", error);
                        alert("Registration failed. Please try again.");
                    }
                });

            // Logout function
            function logout() {
                state.user = null;
                state.cart = [];
                state.billingAddressId = null;
                state.shippingAddressId = null;

                document.getElementById("auth-button").textContent = "Login";
                document.getElementById("auth-button").onclick = () =>
                    showSection("login");

                updateCartUI();
                showSection("home");
            }

            // Place order
            async function placeOrder() {
                if (
                    !state.user ||
                    !state.billingAddressId ||
                    !state.shippingAddressId
                ) {
                    alert("Please login to place an order");
                    showSection("login");
                    return;
                }

                if (state.cart.length === 0) {
                    alert("Your cart is empty");
                    return;
                }

                try {
                    // Calculate total
                    const total = state.cart.reduce(
                        (total, item) => total + item.amount,
                        0,
                    );

                    // Prepare sales note contents
                    const noteContents = state.cart.map((item) => ({
                        product_id: item.productId,
                        quantity: item.quantity,
                        unit_price: item.unitPrice,
                        amount: item.amount,
                    }));

                    // Create sales note
                    const salesNoteResponse = await fetch(
                        `${API_BASE_URL}/sales-notes/`,
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({
                                customer_id: state.user.id,
                                billing_address_id: state.billingAddressId,
                                shipping_address_id: state.shippingAddressId,
                                total: total,
                                note_contents: noteContents,
                            }),
                        },
                    );

                    if (!salesNoteResponse.ok) {
                        throw new Error("Failed to create sales note");
                    }

                    // Clear cart
                    state.cart = [];
                    updateCartUI();

                    // Show confirmation
                    showSection("order-confirmation");
                } catch (error) {
                    console.error("Order error:", error);
                    alert("Failed to place order. Please try again.");
                }
            }

            // Initialize the app
            window.onload = function () {
                loadMenu();
                showSection("home");
            };
        </script>
    </body>
</html>
